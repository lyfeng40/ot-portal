<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="./icon.png">
    <link rel="apple-touch-icon" href="./icon.png">
    <meta name="theme-color" content="#2F4F4F">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç²¾ç¥é†«å­¸éƒ¨è·èƒ½æ²»ç™‚å…¥å£ç¶²</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@500;700&family=Noto+Sans+TC:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root { --bg-paper: #F2EAD3; --forest-green: #2F4F4F; --twilight-blue: #4A6C8C; --brick-red: #C05546; --warm-light: #F9E79F; --ink-black: #2C3E50; --shadow-retro: 4px 4px 0px rgba(47, 79, 79, 0.2); --radius: 8px; --empty-slot: #E8F5E9; --busy-slot: #FFEBEE; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-paper); color: var(--ink-black); margin: 0; padding: 20px; min-height: 100vh; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E"); }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--forest-green); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s; }
        .login-box { background: #FDFBF7; padding: 40px; border-radius: 12px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); width: 80%; max-width: 300px; }
        .login-title { font-family: 'Noto Serif TC', serif; font-size: 1.5rem; color: var(--forest-green); margin-bottom: 20px; }
        .login-input { width: 100%; padding: 12px; font-size: 1.2rem; text-align: center; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 20px; letter-spacing: 5px; box-sizing: border-box; }
        .login-btn { background: var(--brick-red); color: white; border: none; padding: 10px 30px; font-size: 1rem; border-radius: 6px; cursor: pointer; width: 100%; }
        .error-msg { color: #C62828; margin-top: 15px; font-size: 0.9rem; display: none; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-10px); } 50% { transform: translateX(10px); } 75% { transform: translateX(-10px); } 100% { transform: translateX(0); } }
        .header { text-align: center; margin-bottom: 40px; padding-top: 30px; }
        .header h1 { font-family: 'Noto Serif TC', serif; margin: 0; font-size: 2rem; color: var(--forest-green); text-shadow: 2px 2px 0px rgba(255,255,255,0.5); letter-spacing: 3px; }
        .header p { margin: 15px 0 0; font-size: 1rem; color: #6B7A8F; font-style: italic; font-weight: 500; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 30px; max-width: 1200px; margin: 0 auto; padding-bottom: 100px; }
        .card { background: #FDFBF7; border: 2px solid var(--forest-green); border-radius: var(--radius); box-shadow: var(--shadow-retro); transition: transform 0.2s; overflow: hidden; display: flex; flex-direction: column; }
        .card:hover { transform: translate(-2px, -2px); }
        .card-header { background-color: var(--forest-green); color: #FDFBF7; padding: 15px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--forest-green); }
        .card-title { font-family: 'Noto Serif TC', serif; font-size: 1.15rem; font-weight: 700; }
        .toggle-icon { transition: transform 0.3s; }
        .card.active .toggle-icon { transform: rotate(180deg); }
        .card[data-type="meeting"] .card-header { background-color: var(--forest-green); }
        .card[data-type="calendar"] .card-header { background-color: var(--twilight-blue); }
        .card[data-type="room"] .card-header { background-color: var(--brick-red); }
        .card[data-type="custom"] .card-header { background-color: #8D6E63; }
        .card-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, opacity 0.3s ease; background-color: #FDFBF7; opacity: 0; }
        .card.active .card-content { opacity: 1; }
        .content-inner { padding: 20px; }
        .btn { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; margin-bottom: 10px; background: #FFF; border: 1px solid #D1D1D1; border-radius: 6px; color: var(--ink-black); text-decoration: none; transition: background 0.2s; }
        .btn:hover { background-color: #F4F4F4; }
        .btn small { color: #888; font-size: 0.8rem; display: block; }
        .badge { font-size: 0.7rem; padding: 2px 6px; background: #EAEAEA; border-radius: 4px; color: #555; }
        .inline-add-btn { display: flex; justify-content: center; align-items: center; padding: 10px; margin-top: 15px; border: 2px dashed #CCC; border-radius: 6px; color: #888; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; }
        .inline-add-btn:hover { border-color: var(--forest-green); color: var(--forest-green); background: #F9F9F9; }
        .fab-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--brick-red); color: white; border-radius: 50%; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 30px; cursor: pointer; z-index: 100; transition: transform 0.2s; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.7); backdrop-filter: blur(2px); justify-content: center; align-items: center; z-index: 1001; }
        .modal-content { background: #FDFBF7; padding: 25px; border-radius: 12px; width: 320px; border: 2px solid var(--forest-green); text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .modal-btn { padding: 8px 20px; background: var(--forest-green); color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        .room-section { margin-bottom: 25px; border: 1px solid #ddd; padding: 10px; border-radius: 8px; background: #fff;}
        .room-section h3 { margin: 0 0 10px 0; color: var(--brick-red); font-size: 1rem; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .schedule-grid { display: grid; grid-template-columns: 40px repeat(5, 1fr); gap: 5px; font-size: 0.8rem; align-items: center; }
        .schedule-header { text-align: center; font-weight: bold; color: #666; padding-bottom: 5px;}
        .schedule-label { font-weight: bold; color: var(--forest-green); }
        .schedule-select { width: 100%; padding: 2px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.75rem; background: white; }
        .unused-display-area { margin-top: 15px; padding: 10px; background: var(--empty-slot); border: 1px dashed var(--forest-green); border-radius: 6px; font-size: 0.85rem; color: var(--forest-green); }
        .unused-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
        .unused-tag { background: white; border: 1px solid #A5D6A7; padding: 2px 8px; border-radius: 10px; font-weight: bold; }
        .remark-area { width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #D1D1D1; border-radius: 6px; font-family: inherit; resize: vertical; box-sizing: border-box; background: #FFF; min-height: 60px; }
        .input-label { font-size: 0.85rem; color: #888; display: block; margin-top: 10px; margin-bottom: 4px; font-weight: bold; }
        /* ç­†è¨˜å¡ç‰‡æ¨£å¼ */
        .memo-block { margin-bottom: 15px; }
        .memo-title { font-weight: bold; color: var(--forest-green); display: block; margin-bottom: 5px; }
        .memo-input { width: 100%; min-height: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: #fffdf0; font-family: inherit; resize: vertical; }
    </style>
</head>
<body>
    <div id="login-overlay">
        <div class="login-box">
            <div class="login-title">ğŸ”’ ç™»å…¥å…¥å£ç¶²</div>
            <input type="password" id="site-password" class="login-input" placeholder="è¼¸å…¥å¯†ç¢¼">
            <button class="login-btn" onclick="checkPassword()">ç™»å…¥</button>
            <div id="login-error" class="error-msg">å¯†ç¢¼éŒ¯èª¤</div>
        </div>
    </div>
    <div class="header"><h1>ç²¾ç¥é†«å­¸éƒ¨è·èƒ½æ²»ç™‚å…¥å£ç¶²</h1><p id="daily-quote">Loading...</p></div>
    <div class="grid" id="cardContainer"></div>

    <button class="fab-btn" onclick="openAddModal()">ï¼‹</button>

    <div id="add-modal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--forest-green); margin-top:0;">æ–°å¢å…§å®¹</h3>
            <div id="category-selector-group">
                <select id="new-card-select" class="modal-input"></select>
            </div>
            <div id="input-new-card-title" style="display:none;">
                <input type="text" id="new-card-title" placeholder="è¼¸å…¥æ–°å¡ç‰‡æ¨™é¡Œ" class="modal-input">
            </div>
            
            <div style="text-align:left; margin-top:10px;">
                <label class="input-label" style="margin-bottom:5px;">å…§å®¹é¡å‹ï¼š</label>
                <select id="new-item-type" class="modal-input" onchange="toggleUrlInput()" style="margin-top:0;">
                    <option value="link">ğŸ”— ç¶²é é€£çµ (æŒ‰éˆ•)</option>
                    <option value="editable_memo">âœï¸ å¾…è¾¦/ç­†è¨˜ (å¯ç·¨è¼¯)</option>
                    <option value="memo">ğŸ“ ç´”æ–‡å­—å…¬å‘Š (ä¸å¯ç·¨è¼¯)</option>
                </select>
            </div>

            <input type="text" id="new-link-name" placeholder="æ¨™é¡Œ" class="modal-input">
            <div id="url-input-group">
                <input type="text" id="new-link-url" placeholder="ç¶²å€ (ä¾‹å¦‚: https://...)" class="modal-input">
            </div>
            <textarea id="new-link-desc" placeholder="å…§å®¹èªªæ˜" class="modal-input" style="height:80px; resize:none; font-family:inherit;"></textarea>

            <div style="display:flex; justify-content: space-between; margin-top:10px;">
                <button class="modal-btn" style="background:#888;" onclick="closeAddModal()">å–æ¶ˆ</button>
                <button class="modal-btn" onclick="saveNewItem()">ç¢ºå®šæ–°å¢</button>
            </div>
        </div>
    </div>

    <div id="roster-modal" class="modal">
        <div class="modal-content" style="max-width:600px; width:95%; max-height:90vh; overflow-y:auto;">
            <span style="float:right; cursor:pointer; font-size:1.5rem;" onclick="document.getElementById('roster-modal').style.display='none'">&times;</span>
            <h2 style="color:var(--forest-green); margin-top:0;">æœ¬æœˆæ’ç­è¡¨</h2>
            <div style="background:#FFEBEE; color:#C62828; padding:10px; border-radius:6px; margin-bottom:15px; font-weight:bold; border:1px solid #EF9A9A;">
                ğŸš‘ ä»Šæ—¥è«‹å‡ï¼š<span id="leave-display-text">è¼‰å…¥ä¸­...</span>
            </div>
            <div style="text-align:center;">
                <img src="./roster.jpg" style="width:100%; height:auto; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,0.1);" onerror="this.style.display='none'; this.parentElement.innerHTML='[å°šæœªä¸Šå‚³ roster.jpg]'">
            </div>
        </div>
    </div>

    <script>
        // â˜…â˜…â˜… è«‹æ›¿æ›æˆä½ çš„ GAS ç¶²å€ â˜…â˜…â˜…
        const API_URL = "https://script.google.com/macros/s/AKfycbw6HotMwrrkXmYJM1yJNUZonTABHIeEv03odAsN8YS4EgCosc31mUFHHfURVJJKTc7x/exec";
        let CURRENT_USER_PASS = ""; 

        const isLogged = sessionStorage.getItem("ot_logged_in_pass");
        if(isLogged) {
            document.getElementById("login-overlay").style.display = "none";
            CURRENT_USER_PASS = isLogged;
            loadDataCloud(); 
        }

        function checkPassword() {
            const input = document.getElementById("site-password").value;
            const errorMsg = document.getElementById("login-error");
            if (input) {
                CURRENT_USER_PASS = input;
                document.getElementById('daily-quote').innerText = "é©—è­‰å¯†ç¢¼ä¸­...";
                loadDataCloud(true); // å‚³å…¥ true è¡¨ç¤ºæ˜¯ç™»å…¥é©—è­‰
            } else {
                errorMsg.style.display = "block";
            }
        }
        document.getElementById("site-password").addEventListener("keypress", function(event) { if (event.key === "Enter") checkPassword(); });

        const roomOptions = ["ç©ºç¼º", "æˆç™®", "å­¸ç”Ÿ", "æ€¥æ€§", "ICF", "èº«å¿ƒéšœç¤™é‘‘å®š", "æ¡ŒéŠ", "å¿—å·¥", "å…¶ä»–"];
        const days = ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”"];
        
        let appData = [];
        let roomData = { assess: Array(5).fill(null).map(() => ({ am: "ç©ºç¼º", pm: "ç©ºç¼º" })), room2: Array(5).fill(null).map(() => ({ am: "ç©ºç¼º", pm: "ç©ºç¼º" })), remark: "" };
        let calendarNote = "";
        let rosterData = { leave: "", remark: "" };
        let memoData = {}; // â˜… ç­†è¨˜è³‡æ–™
        let todayQuoteFromServer = "è¼‰å…¥ä¸­..."; 
        let calendarEventsFromServer = "æ­£åœ¨è®€å–è¡Œäº‹æ›†..."; 

        function loadDataCloud(isLogin = false) {
            document.getElementById('daily-quote').innerText = "â˜ï¸ è³‡æ–™åŒæ­¥ä¸­...";
            fetch(API_URL + "?action=read&password=" + CURRENT_USER_PASS)
            .then(res => res.json())
            .then(res => {
                if(res.status === 'success') {
                    if (isLogin) {
                        document.getElementById("login-overlay").style.display = "none";
                        sessionStorage.setItem("ot_logged_in_pass", CURRENT_USER_PASS);
                    }
                    if(res.data.appData) appData = res.data.appData;
                    if(res.data.roomData) roomData = res.data.roomData;
                    if(res.data.rosterData) rosterData = res.data.rosterData;
                    if(res.data.calendarNote) calendarNote = res.data.calendarNote;
                    if(res.data.memoData) memoData = res.data.memoData; // è¼‰å…¥ç­†è¨˜
                    if(res.data.todayQuote) todayQuoteFromServer = res.data.todayQuote;
                    if(res.data.calendarEvents) calendarEventsFromServer = res.data.calendarEvents;
                    console.log("è³‡æ–™åŒæ­¥å®Œæˆ");
                    updateUI(); 
                } else {
                    if (isLogin) {
                        document.getElementById("login-error").innerText = "å¯†ç¢¼éŒ¯èª¤";
                        document.getElementById("login-error").style.display = "block";
                        document.getElementById('daily-quote').innerText = "è«‹ç™»å…¥";
                    } else {
                        console.error("åŒæ­¥å¤±æ•—");
                    }
                }
            })
            .catch(err => { console.error("é€£ç·šéŒ¯èª¤", err); });
        }

        function sendToCloud(type, dataObj) {
            fetch(API_URL + "?password=" + CURRENT_USER_PASS + "&action=write&type=" + type, {
                method: "POST", body: JSON.stringify(dataObj)
            }).then(() => console.log(type + " Saved"));
        }

        function saveRoom() { sendToCloud('room', roomData); updateUnusedDisplay(); }
        function saveCal(val) { calendarNote = val; sendToCloud('cal', val); }
        function saveRoster() { sendToCloud('roster', rosterData); }
        function saveMemo(id, val) { 
            memoData[id] = val; // æ›´æ–°æœ¬åœ°
            sendToCloud('memo', memoData); // å‚³é€å…¨éƒ¨ç­†è¨˜
        }

        // æ–°å¢é …ç›®çš„é‚è¼¯
        window.toggleUrlInput = function() {
            const type = document.getElementById('new-item-type').value;
            const urlGroup = document.getElementById('url-input-group');
            if (type === 'link') {
                urlGroup.style.display = 'block';
            } else {
                urlGroup.style.display = 'none'; // ç­†è¨˜æˆ–å…¬å‘Šéƒ½ä¸éœ€è¦ç¶²å€
            }
        }

        window.saveNewItem = function() {
            const selectVal = document.getElementById('new-card-select').value;
            const itemType = document.getElementById('new-item-type').value; 
            const name = document.getElementById('new-link-name').value;
            let url = document.getElementById('new-link-url').value;
            const desc = document.getElementById('new-link-desc').value;

            // é‚è¼¯åˆ¤æ–·
            if (itemType === 'memo') { url = '#text'; } 
            else if (itemType === 'editable_memo') { url = '#memo'; } // ç‰¹æ®Šæ¨™è¨˜

            if(!name) { alert('è«‹è¼¸å…¥æ¨™é¡Œ'); return; }
            if(itemType === 'link' && !url) { alert('è«‹è¼¸å…¥ç¶²å€'); return; }

            let newLinkData = { id: '', title: '', type: 'custom', name: name, url: url, desc: desc };

            if (selectVal === 'new_card') {
                const newTitle = document.getElementById('new-card-title').value || 'æ–°åˆ†é¡';
                newLinkData.id = 'custom_' + Date.now();
                newLinkData.title = newTitle;
            } else {
                const targetCard = appData.find(c => c.id === selectVal);
                if (targetCard) {
                    newLinkData.id = targetCard.id;
                    newLinkData.title = targetCard.title;
                    newLinkData.type = targetCard.type;
                }
            }

            const btn = document.querySelector('#add-modal .modal-btn:last-child');
            btn.innerText = "å¯«å…¥ä¸­..."; btn.disabled = true;

            fetch(API_URL + "?password=" + CURRENT_USER_PASS + "&action=write&type=addLink", {
                method: "POST", body: JSON.stringify(newLinkData)
            }).then(res => res.json()).then(res => {
                if(res.status === 'success') {
                    alert("âœ… æˆåŠŸï¼"); closeAddModal(); 
                    document.getElementById('new-link-name').value = '';
                    document.getElementById('new-link-url').value = '';
                    document.getElementById('new-link-desc').value = '';
                    loadDataCloud(); 
                } else { alert("å¤±æ•—"); }
            }).finally(() => { btn.innerText = "ç¢ºå®šæ–°å¢"; btn.disabled = false; });
        }

        function updateUI() {
            const today = new Date();
            const dateStr = `${today.getFullYear()}å¹´${today.getMonth()+1}æœˆ${today.getDate()}æ—¥`;
            const displayQuote = todayQuoteFromServer === "è¼‰å…¥ä¸­..." ? "æ—¥æ—¥æ˜¯å¥½æ—¥" : todayQuoteFromServer;
            document.getElementById('daily-quote').innerText = `${dateStr} â€” ${displayQuote}`;
            renderCards();
        }

        function renderCards() {
            const container = document.getElementById('cardContainer');
            container.innerHTML = '';
            if(document.getElementById('leave-display-text')) {
                document.getElementById('leave-display-text').innerText = rosterData.leave || "ç„¡";
            }

            appData.forEach(card => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card';
                cardDiv.setAttribute('data-type', card.type);
                cardDiv.onclick = (e) => toggleCard(cardDiv, e);

                let contentHtml = '';

                if (card.specialContent === 'room-ui') contentHtml = generateRoomUI();
                else if (card.specialContent === 'calendar-ui') {
                     contentHtml = `
                        <div style="background:#FFF9C4; padding:15px; border-radius:4px; margin-bottom:15px; border-left: 5px solid #FBC02D;">
                            <strong style="color:#AF601A; display:block; margin-bottom:8px; border-bottom:1px solid rgba(0,0,0,0.1); padding-bottom:5px;">ğŸ”¥ è¡Œäº‹æ›†é‡é»</strong>
                            <div style="font-size:0.95rem; line-height:1.6; color:#444;">${calendarEventsFromServer}</div>
                        </div>
                        <label class="input-label">ğŸ“ å…¬å‘Šå‚™è¨»</label>
                        <textarea class="remark-area" onchange="saveCal(this.value)" onclick="event.stopPropagation()">${calendarNote}</textarea>
                        <a href="https://calendar.google.com/calendar/embed?src=chimeiotr%40gmail.com&ctz=Asia%2FTaipei" target="_blank" class="btn" style="border-left:4px solid var(--twilight-blue); margin-top:10px;"><div>æŸ¥çœ‹å®Œæ•´æœˆæ›†</div></a>`;
                }
                else if (card.specialContent === 'roster-ui') {
                    contentHtml = `
                        <label class="input-label">ğŸš‘ ä»Šæ—¥è«‹å‡</label>
                        <input type="text" class="modal-input" value="${rosterData.leave}" oninput="rosterData.leave=this.value; saveRoster();" onclick="event.stopPropagation()">
                        <div class="btn" onclick="event.stopPropagation(); document.getElementById('roster-modal').style.display='flex'"><div>æœ¬æœˆæ’ç­è¡¨</div></div>
                        <textarea class="remark-area" onchange="rosterData.remark=this.value; saveRoster()" onclick="event.stopPropagation()">${rosterData.remark}</textarea>`;
                }

                if (card.links) { 
                    card.links.forEach((link, idx) => { 
                        // 1. ç´”æ–‡å­—å…¬å‘Š (#text)
                        if (link.url === '#text' || link.url === '') {
                            contentHtml += `<div style="padding:10px; background:#f4f4f4; border-radius:6px; margin-bottom:8px; color:#555;"><strong>${link.name}</strong><br>${link.desc}</div>`;
                        } 
                        // 2. â˜… å¯ç·¨è¼¯ç­†è¨˜ (#memo) - é€™æ˜¯æ–°åŠŸèƒ½
                        else if (link.url === '#memo') {
                            // ç”¢ç”Ÿä¸€å€‹å”¯ä¸€ keyï¼Œçµ„åˆå¡ç‰‡ID+ç´¢å¼•ï¼Œç¢ºä¿ä¸é‡è¤‡
                            const memoKey = card.id + '_memo_' + idx; 
                            const memoValue = memoData[memoKey] || ""; // å¾è³‡æ–™åº«è®€å€¼
                            contentHtml += `
                                <div class="memo-block" onclick="event.stopPropagation()">
                                    <label class="memo-title">âœï¸ ${link.name}</label>
                                    <textarea class="memo-input" placeholder="${link.desc}" onchange="saveMemo('${memoKey}', this.value)">${memoValue}</textarea>
                                </div>
                            `;
                        }
                        // 3. ä¸€èˆ¬é€£çµ
                        else {
                            contentHtml += `<a href="${link.url}" target="_blank" class="btn"><div>${link.name}<small>${link.desc || ''}</small></div><span class="badge">GO</span></a>`; 
                        }
                    }); 
                }
                
                if (card.allowAdd) { 
                    contentHtml += `<div class="inline-add-btn" onclick="event.stopPropagation(); openAddModal('${card.id}')">+ æ–°å¢å…§å®¹</div>`; 
                }

                cardDiv.innerHTML = `<div class="card-header"><span class="card-title">${card.title}</span><span class="toggle-icon">â–¼</span></div><div class="card-content"><div class="content-inner">${contentHtml}</div></div>`;
                container.appendChild(cardDiv);
            });
            updateUnusedDisplay();
        }

        function generateRoomUI() {
            const mkSel = (roomKey, dayIdx, timeKey) => {
                let currentVal = roomData[roomKey][dayIdx][timeKey];
                let opts = roomOptions.map(o => `<option value="${o}" ${o===currentVal?'selected':''}>${o}</option>`).join('');
                return `<select class="schedule-select" onchange="updateRoomData('${roomKey}', ${dayIdx}, '${timeKey}', this.value)">${opts}</select>`;
            };
            const mkRows = (roomKey) => {
                let amRow = `<div class="schedule-label">ä¸Šåˆ</div>`, pmRow = `<div class="schedule-label">ä¸‹åˆ</div>`;
                days.forEach((d, i) => { amRow += `<div>${mkSel(roomKey, i, 'am')}</div>`; pmRow += `<div>${mkSel(roomKey, i, 'pm')}</div>`; });
                return amRow + pmRow;
            };
            const headerRow = `<div></div>` + days.map(d => `<div class="schedule-header">${d}</div>`).join('');
            return `<div class="unused-display-area" id="unused-list-display">è¨ˆç®—ä¸­...</div><div class="room-section" onclick="event.stopPropagation()"><h3>ğŸ©º è©•ä¼°å®¤</h3><div class="schedule-grid">${headerRow}${mkRows('assess')}</div></div><div class="room-section" onclick="event.stopPropagation()"><h3>ğŸ‹ï¸ æ´»å‹•å®¤ II</h3><div class="schedule-grid">${headerRow}${mkRows('room2')}</div></div><label class="input-label">ğŸ“ ç©ºé–“å‚™è¨»</label><textarea class="remark-area" onchange="roomData.remark=this.value; saveRoom()" onclick="event.stopPropagation()">${roomData.remark}</textarea>`;
        }
        window.updateRoomData = function(roomKey, dayIdx, timeKey, value) { roomData[roomKey][dayIdx][timeKey] = value; saveRoom(); };
        function updateUnusedDisplay() {
            const disp = document.getElementById('unused-list-display'); if(!disp) return;
            let emptyList = [];
            days.forEach((day, i) => {
                if(roomData.assess[i].am === 'ç©ºç¼º') emptyList.push(`è©•ä¼°å®¤(é€±${day}ä¸Š)`); if(roomData.assess[i].pm === 'ç©ºç¼º') emptyList.push(`è©•ä¼°å®¤(é€±${day}ä¸‹)`);
                if(roomData.room2[i].am === 'ç©ºç¼º') emptyList.push(`æ´»å‹•å®¤II(é€±${day}ä¸Š)`); if(roomData.room2[i].pm === 'ç©ºç¼º') emptyList.push(`æ´»å‹•å®¤II(é€±${day}ä¸‹)`);
            });
            if (emptyList.length > 0) { disp.innerHTML = `<strong>ğŸŸ¢ æœ¬é€±ç©ºé–’æ™‚æ®µï¼š</strong><div class="unused-list">${emptyList.map(t => `<span class="unused-tag">${t}</span>`).join('')}</div>`; disp.style.background = "var(--empty-slot)"; disp.style.color = "var(--forest-green)"; }
            else { disp.innerHTML = `<strong>ğŸ”´ æœ¬é€±å·²å…¨æ»¿</strong>`; disp.style.background = "var(--busy-slot)"; disp.style.color = "#C62828"; }
        }

        window.openAddModal = function(targetId = null) {
            const modal = document.getElementById('add-modal');
            const selectGroup = document.getElementById('category-selector-group');
            const select = document.getElementById('new-card-select');
            updateSelectOptions();
            if (targetId) { selectGroup.style.display = 'none'; select.value = targetId; } else { selectGroup.style.display = 'block'; select.value = 'new_card'; }
            select.dispatchEvent(new Event('change')); modal.style.display = 'flex';
        }
        window.closeAddModal = function() { document.getElementById('add-modal').style.display = 'none'; }
        document.getElementById('new-card-select').addEventListener('change', function() { document.getElementById('input-new-card-title').style.display = (this.value === 'new_card') ? 'block' : 'none'; });
        function updateSelectOptions() {
            const select = document.getElementById('new-card-select'); select.innerHTML = '<option value="new_card">âœ¨ å»ºç«‹ä¸€å¼µå…¨æ–°å¡ç‰‡</option>';
            appData.forEach(card => { if (card.allowAdd) { const opt = document.createElement('option'); opt.value = card.id; opt.text = `åŠ å…¥è‡³ã€Œ${card.title}ã€`; select.insertBefore(opt, select.firstChild); } });
        }
        function toggleCard(card, event) {
            if(event.target.closest('select') || event.target.closest('textarea') || event.target.closest('input') || event.target.closest('a') || event.target.closest('.inline-add-btn') || event.target.closest('.room-section')) { return; }
            const content = card.querySelector('.card-content'); const isActive = card.classList.contains('active');
            if (!isActive) { card.classList.add('active'); content.style.maxHeight = content.scrollHeight + 800 + "px"; } else { card.classList.remove('active'); content.style.maxHeight = null; }
        }
    </script>
</body>
</html>
